'use strict';

var _ = require('lodash');
var util = require('util');

var datatypes = require('./datatypes');

var schemer = {
  validate_table_name(tableName) {
    return typeof tableName === 'string' && /^[a-zA-Z]+[a-zA-Z0-9_]*/.test(tableName);
  },
  has_field(modelSchema, fieldName) {
    var optionFieldNames = [];
    if (modelSchema.options) {
      if (modelSchema.options.timestamps) {
        var timestampOptions = {
          createdAt: modelSchema.options.timestamps.createdAt || 'createdAt',
          updatedAt: modelSchema.options.timestamps.updatedAt || 'updatedAt'
        };
        optionFieldNames.push(timestampOptions.createdAt);
        optionFieldNames.push(timestampOptions.updatedAt);
      }

      if (modelSchema.options.versions) {
        var versionOptions = {
          key: modelSchema.options.versions.key || '__v'
        };
        optionFieldNames.push(versionOptions.key);
      }
    }
    return _.has(modelSchema.fields, fieldName) || optionFieldNames.includes(fieldName);
  },
  validate_field(modelSchema, fieldObject, fieldName) {
    if (!fieldObject) {
      throw new Error(util.format('Schema field "%s" is not properly defined', fieldName));
    }
    var fieldtype = this.get_field_type(modelSchema, fieldName);
    if (!_.has(datatypes, fieldtype)) {
      throw new Error(util.format('Invalid field type "%s" for field: %s', fieldtype, fieldName));
    }
    if (['map', 'list', 'set', 'frozen'].includes(fieldtype)) {
      if (!fieldObject.typeDef) {
        throw new Error(util.format('Missing typeDef for field type "%s" on field: %s', fieldtype, fieldName));
      }
      if (typeof fieldObject.typeDef !== 'string') {
        throw new Error(util.format('Invalid typeDef for field type "%s" on field: %s', fieldtype, fieldName));
      }
    }
    if (!this.is_field_default_value_valid(modelSchema, fieldName)) {
      throw new Error(util.format('Invalid default value for field: %s(%s)', fieldName, fieldtype));
    }
  },

  validate_primary_key(modelSchema) {
    var _this = this;

    if (typeof modelSchema.key[0] === 'string') {
      if (!this.has_field(modelSchema, modelSchema.key[0])) {
        throw new Error('Partition Key must also be a valid field name');
      }
      if (modelSchema.fields[modelSchema.key[0]] && modelSchema.fields[modelSchema.key[0]].virtual) {
        throw new Error("Partition Key must also be a db field name, can't be a virtual field name");
      }
    } else if (_.isArray(modelSchema.key[0])) {
      if (modelSchema.key[0].length === 0) {
        throw new Error("Partition Key array can't be empty");
      }
      modelSchema.key[0].forEach(function (partitionKeyField) {
        if (typeof partitionKeyField !== 'string' || !_this.has_field(modelSchema, partitionKeyField)) {
          throw new Error('Partition Key array must contain only valid field names');
        }
        if (modelSchema.fields[partitionKeyField] && modelSchema.fields[partitionKeyField].virtual) {
          throw new Error("Partition Key array must contain only db field names, can't contain virtual field names");
        }
      });
    } else {
      throw new Error('Partition Key must be a field name string, or array of field names');
    }

    modelSchema.key.forEach(function (primaryKeyField, primaryKeyIndex) {
      if (primaryKeyIndex > 0) {
        if (typeof primaryKeyField !== 'string' || !_this.has_field(modelSchema, primaryKeyField)) {
          throw new Error('Clustering Keys must be valid field names');
        }
        if (modelSchema.fields[primaryKeyField] && modelSchema.fields[primaryKeyField].virtual) {
          throw new Error("Clustering Keys must be db field names, can't be virtual field names");
        }
      }
    });

    if (modelSchema.clustering_order) {
      if (!_.isPlainObject(modelSchema.clustering_order)) {
        throw new Error('clustering_order must be an object of clustering_key attributes');
      }

      _.forEach(modelSchema.clustering_order, function (clusteringOrder, clusteringFieldName) {
        if (!['asc', 'desc'].includes(clusteringOrder.toLowerCase())) {
          throw new Error('clustering_order attribute values can only be ASC or DESC');
        }
        if (modelSchema.key.indexOf(clusteringFieldName) < 1) {
          throw new Error('clustering_order field attributes must be clustering keys only');
        }
      });
    }
  },

  validate_materialized_view(modelSchema, materializedViewObject, materializedViewName) {
    var _this2 = this;

    if (!_.isPlainObject(materializedViewObject)) {
      throw new Error(util.format('attribute "%s" under materialized_views must be an object', materializedViewName));
    }

    if (!materializedViewObject.select || !materializedViewObject.key) {
      throw new Error(util.format('materialized_view "%s" must have "select" and "key" attributes', materializedViewName));
    }

    if (!_.isArray(materializedViewObject.select) || !_.isArray(materializedViewObject.key)) {
      throw new Error(util.format('"select" and "key" attributes must be an array under attribute %s of materialized_views', materializedViewName));
    }

    materializedViewObject.select.forEach(function (materializedViewSelectField) {
      if (typeof materializedViewSelectField !== 'string' || !(_this2.has_field(modelSchema, materializedViewSelectField) || materializedViewSelectField === '*')) {
        throw new Error(util.format('the select attribute under materialized_view %s must be an array of field name strings or ["*"]', materializedViewName));
      }

      if (modelSchema.fields[materializedViewSelectField] && modelSchema.fields[materializedViewSelectField].virtual) {
        throw new Error(util.format('the select attribute under %s of materialized_views must be an array of db field names, ' + 'cannot contain any virtual field name', materializedViewName));
      }
    });

    // validate materialized_view primary key
    if (typeof materializedViewObject.key[0] === 'string') {
      if (!this.has_field(modelSchema, materializedViewObject.key[0])) {
        throw new Error(util.format('materialized_view %s: partition key string must match a valid field name', materializedViewName));
      }
      if (modelSchema.fields[materializedViewObject.key[0]] && modelSchema.fields[materializedViewObject.key[0]].virtual) {
        throw new Error(util.format('materialized_view %s: partition key must match a db field name, cannot be a virtual field name', materializedViewName));
      }
    } else if (_.isArray(materializedViewObject.key[0])) {
      if (materializedViewObject.key[0].length === 0) {
        throw new Error(util.format('materialized_view %s: partition key array cannot be empty', materializedViewName));
      }
      materializedViewObject.key[0].forEach(function (materializedViewPartitionKeyField) {
        if (typeof materializedViewPartitionKeyField !== 'string' || !_this2.has_field(modelSchema, materializedViewPartitionKeyField)) {
          throw new Error(util.format('materialized_view %s: partition key array must contain only valid field names', materializedViewName));
        }
        if (modelSchema.fields[materializedViewPartitionKeyField] && modelSchema.fields[materializedViewPartitionKeyField].virtual) {
          throw new Error(util.format('materialized_view %s: partition key array must contain only db field names, ' + 'cannot contain virtual field names', materializedViewName));
        }
      });
    } else {
      throw new Error(util.format('materialized_view %s: partition key must be a field name string, or array of field names', materializedViewName));
    }

    materializedViewObject.key.forEach(function (materializedViewPrimaryKeyField, materializedViewPrimaryKeyIndex) {
      if (materializedViewPrimaryKeyIndex > 0) {
        if (typeof materializedViewPrimaryKeyField !== 'string' || !_this2.has_field(modelSchema, materializedViewPrimaryKeyField)) {
          throw new Error(util.format('materialized_view %s: clustering keys must be valid field names', materializedViewName));
        }
        if (modelSchema.fields[materializedViewPrimaryKeyField] && modelSchema.fields[materializedViewPrimaryKeyField].virtual) {
          throw new Error(util.format('materialized_view %s: clustering keys must be db field names, cannot contain virtual fields', materializedViewName));
        }
      }
    });

    if (materializedViewObject.clustering_order) {
      if (!_.isPlainObject(materializedViewObject.clustering_order)) {
        throw new Error(util.format('materialized_view %s: clustering_order must be an object of clustering_key attributes', materializedViewName));
      }

      _.forEach(materializedViewObject.clustering_order, function (mvClusteringOrder, mvlusteringFieldName) {
        if (!['asc', 'desc'].includes(mvClusteringOrder.toLowerCase())) {
          throw new Error(util.format('materialized_view %s: clustering_order attribute values can only be ASC or DESC', materializedViewName));
        }
        if (materializedViewObject.key.indexOf(mvlusteringFieldName) < 1) {
          throw new Error(util.format('materialized_view %s: clustering_order field attributes must be clustering keys only', materializedViewName));
        }
      });
    }
  },

  validate_index(modelSchema, indexDef) {
    if (typeof indexDef !== 'string') {
      throw new Error('indexes must be an array of strings');
    }

    var indexNameList = indexDef.replace(/["\s]/g, '').split(/[()]/g);
    if (indexNameList.length > 1) {
      indexNameList[0] = indexNameList[0].toLowerCase();
      if (!['entries', 'keys', 'values', 'full'].includes(indexNameList[0])) {
        throw new Error(util.format('index "%s" is not defined properly', indexDef));
      }
      if (!this.has_field(modelSchema, indexNameList[1])) {
        throw new Error(util.format('"%s" is not a valid field name, indexes must be defined on field names', indexNameList[1]));
      }
      if (modelSchema.fields[indexNameList[1]] && modelSchema.fields[indexNameList[1]].virtual) {
        throw new Error("indexes must be an array of db field names, can't contain virtual fields");
      }
    } else {
      if (!this.has_field(modelSchema, indexNameList[0])) {
        throw new Error(util.format('"%s" is not a valid field, indexes must be defined on field names', indexNameList[0]));
      }
      if (modelSchema.fields[indexNameList[0]] && modelSchema.fields[indexNameList[0]].virtual) {
        throw new Error("indexes must be an array of db field names, can't contain virtual fields");
      }
    }
  },

  validate_custom_index(modelSchema, customIndex) {
    if (!_.isPlainObject(customIndex)) {
      throw new Error('custom_index must be an object with proper indexing attributes');
    }
    if (typeof customIndex.on !== 'string' || !this.has_field(modelSchema, customIndex.on)) {
      throw new Error("custom_index must have an 'on' attribute with string value and value must be a valid field name");
    }
    if (modelSchema.fields[customIndex.on] && modelSchema.fields[customIndex.on].virtual) {
      throw new Error("custom_index 'on' attribute must be a db field name, can't contain virtual fields");
    }
    if (typeof customIndex.using !== 'string') {
      throw new Error("custom_index must have a 'using' attribute with string value");
    }
    if (!_.isPlainObject(customIndex.options)) {
      throw new Error('custom_index must have an "options" attribute and it must be an object, ' + 'pass blank {} object if no options are required');
    }
  },

  validate_model_schema(modelSchema) {
    var _this3 = this;

    if (!modelSchema) {
      throw new Error('A schema must be specified');
    }

    if (!_.isPlainObject(modelSchema.fields) || Object.keys(modelSchema.fields).length === 0) {
      throw new Error('Schema must contain a non-empty "fields" map object');
    }

    if (!modelSchema.key || !_.isArray(modelSchema.key)) {
      throw new Error('Schema must contain "key" in the form: [ [partitionkey1, ...], clusteringkey1, ...]');
    }

    _.forEach(modelSchema.fields, function (fieldObject, fieldName) {
      _this3.validate_field(modelSchema, fieldObject, fieldName);
    });

    this.validate_primary_key(modelSchema);

    if (modelSchema.materialized_views) {
      if (!_.isPlainObject(modelSchema.materialized_views)) {
        throw new Error('materialized_views must be an object with view names as attributes');
      }
      _.forEach(modelSchema.materialized_views, function (materializedViewObject, materializedViewName) {
        _this3.validate_materialized_view(modelSchema, materializedViewObject, materializedViewName);
      });
    }

    if (modelSchema.indexes) {
      if (!_.isArray(modelSchema.indexes)) {
        throw new Error('indexes must be an array of field name strings');
      }

      modelSchema.indexes.forEach(function (indexDef) {
        _this3.validate_index(modelSchema, indexDef);
      });
    }

    if (modelSchema.custom_index && modelSchema.custom_indexes) {
      throw new Error('both custom_index and custom_indexes are defined in schema, only one of them should be defined');
    }

    if (modelSchema.custom_index) {
      this.validate_custom_index(modelSchema, modelSchema.custom_index);
    }

    if (modelSchema.custom_indexes) {
      if (!_.isArray(modelSchema.custom_indexes)) {
        throw new Error('custom_indexes must be an array with objects with proper indexing attributes');
      }
      modelSchema.custom_indexes.forEach(function (customIndex) {
        _this3.validate_custom_index(modelSchema, customIndex);
      });
    }
  },

  format_validation_rule(rule, fieldname) {
    if (!_.isPlainObject(rule)) {
      throw new Error(util.format('Validation rule for "%s" must be a function or an object', fieldname));
    }
    if (typeof rule.validator !== 'function') {
      throw new Error(util.format('Rule validator for "%s" must be a valid function', fieldname));
    }
    if (!rule.message) {
      rule.message = this.get_generic_validation_message;
    }
    if (typeof rule.message === 'string') {
      rule.message = function f1(message) {
        return util.format(message);
      }.bind(null, rule.message);
    }
    if (typeof rule.message !== 'function') {
      throw new Error(util.format('Invalid validator message for "%s", must be string or a function', fieldname));
    }
    return rule;
  },

  get_generic_validation_message(value, propName, fieldtype) {
    return util.format('Invalid Value: "%s" for Field: %s (Type: %s)', value, propName, fieldtype);
  },

  get_validation_message(validators, value) {
    if (value == null || _.isPlainObject(value) && value.$db_function) {
      return true;
    }

    for (var v = 0; v < validators.length; v++) {
      if (typeof validators[v].validator === 'function') {
        if (!validators[v].validator(value)) {
          return validators[v].message;
        }
      }
    }
    return true;
  },

  get_validators(modelSchema, fieldname) {
    var _this4 = this;

    var validators = [];
    var fieldtype = this.get_field_type(modelSchema, fieldname);
    var typeFieldValidator = datatypes.generic_type_validator(fieldtype);
    var field = modelSchema.fields[fieldname];

    if (typeFieldValidator) {
      if (!(field.rule && field.rule.type_validation === false)) {
        validators.push(typeFieldValidator);
      }
    }

    if (typeof field.rule !== 'undefined') {
      if (typeof field.rule === 'function') {
        field.rule = {
          validator: field.rule,
          message: this.get_generic_validation_message
        };
        validators.push(field.rule);
      } else if (Array.isArray(field.rule.validators)) {
        field.rule.validators.forEach(function (fieldrule) {
          validators.push(_this4.format_validation_rule(fieldrule, fieldname));
        });
      } else if (field.rule.validator) {
        validators.push(this.format_validation_rule(field.rule, fieldname));
      }
    }

    return validators;
  },

  get_field_type(modelSchema, fieldName) {
    var fieldObject = modelSchema.fields[fieldName];

    if (typeof fieldObject === 'string') {
      return fieldObject;
    }
    if (_.isPlainObject(fieldObject)) {
      return fieldObject.type;
    }
    throw new Error(`Type of field "${fieldName}" not defined properly`);
  },

  is_required_field(modelSchema, fieldName) {
    if (modelSchema.fields[fieldName].rule && modelSchema.fields[fieldName].rule.required) {
      return true;
    }
    return false;
  },

  is_primary_key_field(modelSchema, fieldName) {
    if (modelSchema.key.includes(fieldName)) {
      return true;
    }
    if (modelSchema.key[0] instanceof Array && modelSchema.key[0].includes(fieldName)) {
      return true;
    }
    return false;
  },

  is_field_default_value_valid(modelSchema, fieldName) {
    if (_.isPlainObject(modelSchema.fields[fieldName]) && modelSchema.fields[fieldName].default) {
      if (_.isPlainObject(modelSchema.fields[fieldName].default) && !modelSchema.fields[fieldName].default.$db_function) {
        return ['map', 'list', 'set', 'frozen'].includes(modelSchema.fields[fieldName].type);
      }
      return true;
    }
    return true;
  }

};

module.exports = schemer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92YWxpZGF0b3JzL3NjaGVtYS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsInV0aWwiLCJkYXRhdHlwZXMiLCJzY2hlbWVyIiwidmFsaWRhdGVfdGFibGVfbmFtZSIsInRhYmxlTmFtZSIsInRlc3QiLCJoYXNfZmllbGQiLCJtb2RlbFNjaGVtYSIsImZpZWxkTmFtZSIsIm9wdGlvbkZpZWxkTmFtZXMiLCJvcHRpb25zIiwidGltZXN0YW1wcyIsInRpbWVzdGFtcE9wdGlvbnMiLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJwdXNoIiwidmVyc2lvbnMiLCJ2ZXJzaW9uT3B0aW9ucyIsImtleSIsImhhcyIsImZpZWxkcyIsImluY2x1ZGVzIiwidmFsaWRhdGVfZmllbGQiLCJmaWVsZE9iamVjdCIsIkVycm9yIiwiZm9ybWF0IiwiZmllbGR0eXBlIiwiZ2V0X2ZpZWxkX3R5cGUiLCJ0eXBlRGVmIiwiaXNfZmllbGRfZGVmYXVsdF92YWx1ZV92YWxpZCIsInZhbGlkYXRlX3ByaW1hcnlfa2V5IiwidmlydHVhbCIsImlzQXJyYXkiLCJsZW5ndGgiLCJmb3JFYWNoIiwicGFydGl0aW9uS2V5RmllbGQiLCJwcmltYXJ5S2V5RmllbGQiLCJwcmltYXJ5S2V5SW5kZXgiLCJjbHVzdGVyaW5nX29yZGVyIiwiaXNQbGFpbk9iamVjdCIsImNsdXN0ZXJpbmdPcmRlciIsImNsdXN0ZXJpbmdGaWVsZE5hbWUiLCJ0b0xvd2VyQ2FzZSIsImluZGV4T2YiLCJ2YWxpZGF0ZV9tYXRlcmlhbGl6ZWRfdmlldyIsIm1hdGVyaWFsaXplZFZpZXdPYmplY3QiLCJtYXRlcmlhbGl6ZWRWaWV3TmFtZSIsInNlbGVjdCIsIm1hdGVyaWFsaXplZFZpZXdTZWxlY3RGaWVsZCIsIm1hdGVyaWFsaXplZFZpZXdQYXJ0aXRpb25LZXlGaWVsZCIsIm1hdGVyaWFsaXplZFZpZXdQcmltYXJ5S2V5RmllbGQiLCJtYXRlcmlhbGl6ZWRWaWV3UHJpbWFyeUtleUluZGV4IiwibXZDbHVzdGVyaW5nT3JkZXIiLCJtdmx1c3RlcmluZ0ZpZWxkTmFtZSIsInZhbGlkYXRlX2luZGV4IiwiaW5kZXhEZWYiLCJpbmRleE5hbWVMaXN0IiwicmVwbGFjZSIsInNwbGl0IiwidmFsaWRhdGVfY3VzdG9tX2luZGV4IiwiY3VzdG9tSW5kZXgiLCJvbiIsInVzaW5nIiwidmFsaWRhdGVfbW9kZWxfc2NoZW1hIiwiT2JqZWN0Iiwia2V5cyIsIm1hdGVyaWFsaXplZF92aWV3cyIsImluZGV4ZXMiLCJjdXN0b21faW5kZXgiLCJjdXN0b21faW5kZXhlcyIsImZvcm1hdF92YWxpZGF0aW9uX3J1bGUiLCJydWxlIiwiZmllbGRuYW1lIiwidmFsaWRhdG9yIiwibWVzc2FnZSIsImdldF9nZW5lcmljX3ZhbGlkYXRpb25fbWVzc2FnZSIsImYxIiwiYmluZCIsInZhbHVlIiwicHJvcE5hbWUiLCJnZXRfdmFsaWRhdGlvbl9tZXNzYWdlIiwidmFsaWRhdG9ycyIsIiRkYl9mdW5jdGlvbiIsInYiLCJnZXRfdmFsaWRhdG9ycyIsInR5cGVGaWVsZFZhbGlkYXRvciIsImdlbmVyaWNfdHlwZV92YWxpZGF0b3IiLCJmaWVsZCIsInR5cGVfdmFsaWRhdGlvbiIsIkFycmF5IiwiZmllbGRydWxlIiwidHlwZSIsImlzX3JlcXVpcmVkX2ZpZWxkIiwicmVxdWlyZWQiLCJpc19wcmltYXJ5X2tleV9maWVsZCIsImRlZmF1bHQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLElBQUlDLFFBQVEsUUFBUixDQUFWO0FBQ0EsSUFBTUMsT0FBT0QsUUFBUSxNQUFSLENBQWI7O0FBRUEsSUFBTUUsWUFBWUYsUUFBUSxhQUFSLENBQWxCOztBQUVBLElBQU1HLFVBQVU7QUFDZEMsc0JBQW9CQyxTQUFwQixFQUErQjtBQUM3QixXQUFRLE9BQU9BLFNBQVAsS0FBcUIsUUFBckIsSUFBaUMsMEJBQTBCQyxJQUExQixDQUErQkQsU0FBL0IsQ0FBekM7QUFDRCxHQUhhO0FBSWRFLFlBQVVDLFdBQVYsRUFB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QU8sQ0FBQyxLQUFELEVBQVEsTUFBUixFQUFnQixLQUFoQixFQUF1QixRQUF2QixFQUFpQzdELFFBQWpDLENBQTBDZCxZQUFZYSxNQUFaLENBQW1CWixTQUFuQixFQUE4Qm1GLElBQXhFLENBQVA7QUFDRDtBQUNELGFBQU8sSUFBUDtBQUNEO0FBQ0QsV0FBTyxJQUFQO0FBQ0Q7O0FBbmFhLENBQWhCOztBQXVhQUssT0FBT0MsT0FBUCxHQUFpQi9GLE9BQWpCIiwiZmlsZSI6InNjaGVtYS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5cbmNvbnN0IGRhdGF0eXBlcyA9IHJlcXVpcmUoJy4vZGF0YXR5cGVzJyk7XG5cbmNvbnN0IHNjaGVtZXIgPSB7XG4gIHZhbGlkYXRlX3RhYmxlX25hbWUodGFibGVOYW1lKSB7XG4gICAgcmV0dXJuICh0eXBlb2YgdGFibGVOYW1lID09PSAnc3RyaW5nJyAmJiAvXlthLXpBLVpdK1thLXpBLVowLTlfXSovLnRlc3QodGFibGVOYW1lKSk7XG4gIH0sXG4gIGhhc19maWVsZChtb2RlbFNjaGVtYSwgZmllbGROYW1lKSB7XG4gICAgY29uc3Qgb3B0aW9uRmllbGROYW1lcyA9IFtdO1xuICAgIGlmIChtb2RlbFNjaGVtYS5vcHRpb25zKSB7XG4gICAgICBpZiAobW9kZWxTY2hlbWEub3B0aW9ucy50aW1lc3RhbXBzKSB7XG4gICAgICAgIGNvbnN0IHRpbWVzdGFtcE9wdGlvbnMgPSB7XG4gICAgICAgICAgY3JlYXRlZEF0OiBtb2RlbFNjaGVtYS5vcHRpb25zLnRpbWVzdGFtcHMuY3JlYXRlZEF0IHx8ICdjcmVhdGVkQXQnLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbW9kZWxTY2hlbWEub3B0aW9ucy50aW1lc3RhbXBzLnVwZGF0ZWRBdCB8fCAndXBkYXRlZEF0JyxcbiAgICAgICAgfTtcbiAgICAgICAgb3B0aW9uRmllbGROYW1lcy5wdXNoKHRpbWVzdGFtcE9wdGlvbnMuY3JlYXRlZEF0KTtcbiAgICAgICAgb3B0aW9uRmllbGROYW1lcy5wdXNoKHRpbWVzdGFtcE9wdGlvbnMudXBkYXRlZEF0KTtcbiAgICAgIH1cblxuICAgICAgaWYgKG1vZGVsU2NoZW1hLm9wdGlvbnMudmVyc2lvbnMpIHtcbiAgICAgICAgY29uc3QgdmVyc2lvbk9wdGlvbnMgPSB7XG4gICAgICAgICAga2V5OiBtb2RlbFNjaGVtYS5vcHRpb25zLnZlcnNpb25zLmtleSB8fCAnX192JyxcbiAgICAgICAgfTtcbiAgICAgICAgb3B0aW9uRmllbGROYW1lcy5wdXNoKHZlcnNpb25PcHRpb25zLmtleSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBfLmhhcyhtb2RlbFNjaGVtYS5maWVsZHMsIGZpZWxkTmFtZSkgfHwgb3B0aW9uRmllbGROYW1lcy5pbmNsdWRlcyhmaWVsZE5hbWUpO1xuICB9LFxuICB2YWxpZGF0ZV9maWVsZChtb2RlbFNjaGVtYSwgZmllbGRPYmplY3QsIGZpZWxkTmFtZSkge1xuICAgIGlmICghZmllbGRPYmplY3QpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ1NjaGVtYSBmaWVsZCBcIiVzXCIgaXMgbm90IHByb3Blcmx5IGRlZmluZWQnLCBmaWVsZE5hbWUpKSk7XG4gICAgfVxuICAgIGNvbnN0IGZpZWxkdHlwZSA9IHRoaXMuZ2V0X2ZpZWxkX3R5cGUobW9kZWxTY2hlbWEsIGZpZWxkTmFtZSk7XG4gICAgaWYgKCFfLmhhcyhkYXRhdHlwZXMsIGZpZWxkdHlwZSkpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ0ludmFsaWQgZmllbGQgdHlwZSBcIiVzXCIgZm9yIGZpZWxkOiAlcycsIGZpZWxkdHlwZSwgZmllbGROYW1lKSkpO1xuICAgIH1cbiAgICBpZiAoWydtYXAnLCAnbGlzdCcsICdzZXQnLCAnZnJvemVuJ10uaW5jbHVkZXMoZmllbGR0eXBlKSkge1xuICAgICAgaWYgKCFmaWVsZE9iamVjdC50eXBlRGVmKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ01pc3NpbmcgdHlwZURlZiBmb3IgZmllbGQgdHlwZSBcIiVzXCIgb24gZmllbGQ6ICVzJywgZmllbGR0eXBlLCBmaWVsZE5hbWUpKSk7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIGZpZWxkT2JqZWN0LnR5cGVEZWYgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ0ludmFsaWQgdHlwZURlZiBmb3IgZmllbGQgdHlwZSBcIiVzXCIgb24gZmllbGQ6ICVzJywgZmllbGR0eXBlLCBmaWVsZE5hbWUpKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghKHRoaXMuaXNfZmllbGRfZGVmYXVsdF92YWx1ZV92YWxpZChtb2RlbFNjaGVtYSwgZmllbGROYW1lKSkpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ0ludmFsaWQgZGVmYXVsdCB2YWx1ZSBmb3IgZmllbGQ6ICVzKCVzKScsIGZpZWxkTmFtZSwgZmllbGR0eXBlKSkpO1xuICAgIH1cbiAgfSxcblxuICB2YWxpZGF0ZV9wcmltYXJ5X2tleShtb2RlbFNjaGVtYSkge1xuICAgIGlmICh0eXBlb2YgKG1vZGVsU2NoZW1hLmtleVswXSkgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAoIXRoaXMuaGFzX2ZpZWxkKG1vZGVsU2NoZW1hLCBtb2RlbFNjaGVtYS5rZXlbMF0pKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoJ1BhcnRpdGlvbiBLZXkgbXVzdCBhbHNvIGJlIGEgdmFsaWQgZmllbGQgbmFtZScpKTtcbiAgICAgIH1cbiAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbbW9kZWxTY2hlbWEua2V5WzBdXSAmJiBtb2RlbFNjaGVtYS5maWVsZHNbbW9kZWxTY2hlbWEua2V5WzBdXS52aXJ0dWFsKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoXCJQYXJ0aXRpb24gS2V5IG11c3QgYWxzbyBiZSBhIGRiIGZpZWxkIG5hbWUsIGNhbid0IGJlIGEgdmlydHVhbCBmaWVsZCBuYW1lXCIpKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKF8uaXNBcnJheShtb2RlbFNjaGVtYS5rZXlbMF0pKSB7XG4gICAgICBpZiAobW9kZWxTY2hlbWEua2V5WzBdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiUGFydGl0aW9uIEtleSBhcnJheSBjYW4ndCBiZSBlbXB0eVwiKSk7XG4gICAgICB9XG4gICAgICBtb2RlbFNjaGVtYS5rZXlbMF0uZm9yRWFjaCgocGFydGl0aW9uS2V5RmllbGQpID0+IHtcbiAgICAgICAgaWYgKCh0eXBlb2YgKHBhcnRpdGlvbktleUZpZWxkKSAhPT0gJ3N0cmluZycpIHx8ICF0aGlzLmhhc19maWVsZChtb2RlbFNjaGVtYSwgcGFydGl0aW9uS2V5RmllbGQpKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignUGFydGl0aW9uIEtleSBhcnJheSBtdXN0IGNvbnRhaW4gb25seSB2YWxpZCBmaWVsZCBuYW1lcycpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobW9kZWxTY2hlbWEuZmllbGRzW3BhcnRpdGlvbktleUZpZWxkXSAmJiBtb2RlbFNjaGVtYS5maWVsZHNbcGFydGl0aW9uS2V5RmllbGRdLnZpcnR1YWwpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiUGFydGl0aW9uIEtleSBhcnJheSBtdXN0IGNvbnRhaW4gb25seSBkYiBmaWVsZCBuYW1lcywgY2FuJ3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkIG5hbWVzXCIpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ1BhcnRpdGlvbiBLZXkgbXVzdCBiZSBhIGZpZWxkIG5hbWUgc3RyaW5nLCBvciBhcnJheSBvZiBmaWVsZCBuYW1lcycpKTtcbiAgICB9XG5cbiAgICBtb2RlbFNjaGVtYS5rZXkuZm9yRWFjaCgocHJpbWFyeUtleUZpZWxkLCBwcmltYXJ5S2V5SW5kZXgpID0+IHtcbiAgICAgIGlmIChwcmltYXJ5S2V5SW5kZXggPiAwKSB7XG4gICAgICAgIGlmICgodHlwZW9mIChwcmltYXJ5S2V5RmllbGQpICE9PSAnc3RyaW5nJykgfHwgIXRoaXMuaGFzX2ZpZWxkKG1vZGVsU2NoZW1hLCBwcmltYXJ5S2V5RmllbGQpKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignQ2x1c3RlcmluZyBLZXlzIG11c3QgYmUgdmFsaWQgZmllbGQgbmFtZXMnKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1twcmltYXJ5S2V5RmllbGRdICYmIG1vZGVsU2NoZW1hLmZpZWxkc1twcmltYXJ5S2V5RmllbGRdLnZpcnR1YWwpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiQ2x1c3RlcmluZyBLZXlzIG11c3QgYmUgZGIgZmllbGQgbmFtZXMsIGNhbid0IGJlIHZpcnR1YWwgZmllbGQgbmFtZXNcIikpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAobW9kZWxTY2hlbWEuY2x1c3RlcmluZ19vcmRlcikge1xuICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobW9kZWxTY2hlbWEuY2x1c3RlcmluZ19vcmRlcikpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignY2x1c3RlcmluZ19vcmRlciBtdXN0IGJlIGFuIG9iamVjdCBvZiBjbHVzdGVyaW5nX2tleSBhdHRyaWJ1dGVzJykpO1xuICAgICAgfVxuXG4gICAgICBfLmZvckVhY2gobW9kZWxTY2hlbWEuY2x1c3RlcmluZ19vcmRlciwgKGNsdXN0ZXJpbmdPcmRlciwgY2x1c3RlcmluZ0ZpZWxkTmFtZSkgPT4ge1xuICAgICAgICBpZiAoIVsnYXNjJywgJ2Rlc2MnXS5pbmNsdWRlcyhjbHVzdGVyaW5nT3JkZXIudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKCdjbHVzdGVyaW5nX29yZGVyIGF0dHJpYnV0ZSB2YWx1ZXMgY2FuIG9ubHkgYmUgQVNDIG9yIERFU0MnKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmtleS5pbmRleE9mKGNsdXN0ZXJpbmdGaWVsZE5hbWUpIDwgMSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoJ2NsdXN0ZXJpbmdfb3JkZXIgZmllbGQgYXR0cmlidXRlcyBtdXN0IGJlIGNsdXN0ZXJpbmcga2V5cyBvbmx5JykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgdmFsaWRhdGVfbWF0ZXJpYWxpemVkX3ZpZXcobW9kZWxTY2hlbWEsIG1hdGVyaWFsaXplZFZpZXdPYmplY3QsIG1hdGVyaWFsaXplZFZpZXdOYW1lKSB7XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobWF0ZXJpYWxpemVkVmlld09iamVjdCkpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ2F0dHJpYnV0ZSBcIiVzXCIgdW5kZXIgbWF0ZXJpYWxpemVkX3ZpZXdzIG11c3QgYmUgYW4gb2JqZWN0JywgbWF0ZXJpYWxpemVkVmlld05hbWUpKSk7XG4gICAgfVxuXG4gICAgaWYgKCFtYXRlcmlhbGl6ZWRWaWV3T2JqZWN0LnNlbGVjdCB8fCAhbWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXkpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3IFwiJXNcIiBtdXN0IGhhdmUgXCJzZWxlY3RcIiBhbmQgXCJrZXlcIiBhdHRyaWJ1dGVzJywgbWF0ZXJpYWxpemVkVmlld05hbWUpKSk7XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzQXJyYXkobWF0ZXJpYWxpemVkVmlld09iamVjdC5zZWxlY3QpIHx8ICFfLmlzQXJyYXkobWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXkpKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdcInNlbGVjdFwiIGFuZCBcImtleVwiIGF0dHJpYnV0ZXMgbXVzdCBiZSBhbiBhcnJheSB1bmRlciBhdHRyaWJ1dGUgJXMgb2YgbWF0ZXJpYWxpemVkX3ZpZXdzJywgbWF0ZXJpYWxpemVkVmlld05hbWUpKSk7XG4gICAgfVxuXG4gICAgbWF0ZXJpYWxpemVkVmlld09iamVjdC5zZWxlY3QuZm9yRWFjaCgobWF0ZXJpYWxpemVkVmlld1NlbGVjdEZpZWxkKSA9PiB7XG4gICAgICBpZiAoKHR5cGVvZiAobWF0ZXJpYWxpemVkVmlld1NlbGVjdEZpZWxkKSAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICB8fCAhKHRoaXMuaGFzX2ZpZWxkKG1vZGVsU2NoZW1hLCBtYXRlcmlhbGl6ZWRWaWV3U2VsZWN0RmllbGQpXG4gICAgICAgICAgICB8fCBtYXRlcmlhbGl6ZWRWaWV3U2VsZWN0RmllbGQgPT09ICcqJykpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAndGhlIHNlbGVjdCBhdHRyaWJ1dGUgdW5kZXIgbWF0ZXJpYWxpemVkX3ZpZXcgJXMgbXVzdCBiZSBhbiBhcnJheSBvZiBmaWVsZCBuYW1lIHN0cmluZ3Mgb3IgW1wiKlwiXScsXG4gICAgICAgICAgbWF0ZXJpYWxpemVkVmlld05hbWUsXG4gICAgICAgICkpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1ttYXRlcmlhbGl6ZWRWaWV3U2VsZWN0RmllbGRdXG4gICAgICAgICAgJiYgbW9kZWxTY2hlbWEuZmllbGRzW21hdGVyaWFsaXplZFZpZXdTZWxlY3RGaWVsZF0udmlydHVhbCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KFxuICAgICAgICAgICd0aGUgc2VsZWN0IGF0dHJpYnV0ZSB1bmRlciAlcyBvZiBtYXRlcmlhbGl6ZWRfdmlld3MgbXVzdCBiZSBhbiBhcnJheSBvZiBkYiBmaWVsZCBuYW1lcywgJyArXG4gICAgICAgICAgJ2Nhbm5vdCBjb250YWluIGFueSB2aXJ0dWFsIGZpZWxkIG5hbWUnLFxuICAgICAgICAgIG1hdGVyaWFsaXplZFZpZXdOYW1lLFxuICAgICAgICApKSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyB2YWxpZGF0ZSBtYXRlcmlhbGl6ZWRfdmlldyBwcmltYXJ5IGtleVxuICAgIGlmICh0eXBlb2YgKG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGlmICghdGhpcy5oYXNfZmllbGQobW9kZWxTY2hlbWEsIG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdKSkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBzdHJpbmcgbXVzdCBtYXRjaCBhIHZhbGlkIGZpZWxkIG5hbWUnLCBtYXRlcmlhbGl6ZWRWaWV3TmFtZSkpKTtcbiAgICAgIH1cbiAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbbWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXlbMF1dXG4gICAgICAgICYmIG1vZGVsU2NoZW1hLmZpZWxkc1ttYXRlcmlhbGl6ZWRWaWV3T2JqZWN0LmtleVswXV0udmlydHVhbCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KFxuICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBtdXN0IG1hdGNoIGEgZGIgZmllbGQgbmFtZSwgY2Fubm90IGJlIGEgdmlydHVhbCBmaWVsZCBuYW1lJyxcbiAgICAgICAgICBtYXRlcmlhbGl6ZWRWaWV3TmFtZSxcbiAgICAgICAgKSkpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdKSkge1xuICAgICAgaWYgKG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBhcnJheSBjYW5ub3QgYmUgZW1wdHknLCBtYXRlcmlhbGl6ZWRWaWV3TmFtZSkpKTtcbiAgICAgIH1cbiAgICAgIG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdLmZvckVhY2goKG1hdGVyaWFsaXplZFZpZXdQYXJ0aXRpb25LZXlGaWVsZCkgPT4ge1xuICAgICAgICBpZiAoKHR5cGVvZiAobWF0ZXJpYWxpemVkVmlld1BhcnRpdGlvbktleUZpZWxkKSAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICB8fCAhdGhpcy5oYXNfZmllbGQobW9kZWxTY2hlbWEsIG1hdGVyaWFsaXplZFZpZXdQYXJ0aXRpb25LZXlGaWVsZCkpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgJ21hdGVyaWFsaXplZF92aWV3ICVzOiBwYXJ0aXRpb24ga2V5IGFycmF5IG11c3QgY29udGFpbiBvbmx5IHZhbGlkIGZpZWxkIG5hbWVzJyxcbiAgICAgICAgICAgIG1hdGVyaWFsaXplZFZpZXdOYW1lLFxuICAgICAgICAgICkpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobW9kZWxTY2hlbWEuZmllbGRzW21hdGVyaWFsaXplZFZpZXdQYXJ0aXRpb25LZXlGaWVsZF1cbiAgICAgICAgICAmJiBtb2RlbFNjaGVtYS5maWVsZHNbbWF0ZXJpYWxpemVkVmlld1BhcnRpdGlvbktleUZpZWxkXS52aXJ0dWFsKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBhcnJheSBtdXN0IGNvbnRhaW4gb25seSBkYiBmaWVsZCBuYW1lcywgJyArXG4gICAgICAgICAgICAnY2Fubm90IGNvbnRhaW4gdmlydHVhbCBmaWVsZCBuYW1lcycsXG4gICAgICAgICAgICBtYXRlcmlhbGl6ZWRWaWV3TmFtZSxcbiAgICAgICAgICApKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KFxuICAgICAgICAnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IHBhcnRpdGlvbiBrZXkgbXVzdCBiZSBhIGZpZWxkIG5hbWUgc3RyaW5nLCBvciBhcnJheSBvZiBmaWVsZCBuYW1lcycsXG4gICAgICAgIG1hdGVyaWFsaXplZFZpZXdOYW1lLFxuICAgICAgKSkpO1xuICAgIH1cblxuICAgIG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5LmZvckVhY2goKG1hdGVyaWFsaXplZFZpZXdQcmltYXJ5S2V5RmllbGQsIG1hdGVyaWFsaXplZFZpZXdQcmltYXJ5S2V5SW5kZXgpID0+IHtcbiAgICAgIGlmIChtYXRlcmlhbGl6ZWRWaWV3UHJpbWFyeUtleUluZGV4ID4gMCkge1xuICAgICAgICBpZiAoKHR5cGVvZiAobWF0ZXJpYWxpemVkVmlld1ByaW1hcnlLZXlGaWVsZCkgIT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgfHwgIXRoaXMuaGFzX2ZpZWxkKG1vZGVsU2NoZW1hLCBtYXRlcmlhbGl6ZWRWaWV3UHJpbWFyeUtleUZpZWxkKSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBjbHVzdGVyaW5nIGtleXMgbXVzdCBiZSB2YWxpZCBmaWVsZCBuYW1lcycsIG1hdGVyaWFsaXplZFZpZXdOYW1lKSkpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbbWF0ZXJpYWxpemVkVmlld1ByaW1hcnlLZXlGaWVsZF1cbiAgICAgICAgICAmJiBtb2RlbFNjaGVtYS5maWVsZHNbbWF0ZXJpYWxpemVkVmlld1ByaW1hcnlLZXlGaWVsZF0udmlydHVhbCkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoXG4gICAgICAgICAgICAnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IGNsdXN0ZXJpbmcga2V5cyBtdXN0IGJlIGRiIGZpZWxkIG5hbWVzLCBjYW5ub3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkcycsXG4gICAgICAgICAgICBtYXRlcmlhbGl6ZWRWaWV3TmFtZSxcbiAgICAgICAgICApKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChtYXRlcmlhbGl6ZWRWaWV3T2JqZWN0LmNsdXN0ZXJpbmdfb3JkZXIpIHtcbiAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1hdGVyaWFsaXplZFZpZXdPYmplY3QuY2x1c3RlcmluZ19vcmRlcikpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IGNsdXN0ZXJpbmdfb3JkZXIgbXVzdCBiZSBhbiBvYmplY3Qgb2YgY2x1c3RlcmluZ19rZXkgYXR0cmlidXRlcycsXG4gICAgICAgICAgbWF0ZXJpYWxpemVkVmlld05hbWUsXG4gICAgICAgICkpKTtcbiAgICAgIH1cblxuICAgICAgXy5mb3JFYWNoKG1hdGVyaWFsaXplZFZpZXdPYmplY3QuY2x1c3RlcmluZ19vcmRlciwgKG12Q2x1c3RlcmluZ09yZGVyLCBtdmx1c3RlcmluZ0ZpZWxkTmFtZSkgPT4ge1xuICAgICAgICBpZiAoIVsnYXNjJywgJ2Rlc2MnXS5pbmNsdWRlcyhtdkNsdXN0ZXJpbmdPcmRlci50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBjbHVzdGVyaW5nX29yZGVyIGF0dHJpYnV0ZSB2YWx1ZXMgY2FuIG9ubHkgYmUgQVNDIG9yIERFU0MnLCBtYXRlcmlhbGl6ZWRWaWV3TmFtZSkpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXkuaW5kZXhPZihtdmx1c3RlcmluZ0ZpZWxkTmFtZSkgPCAxKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogY2x1c3RlcmluZ19vcmRlciBmaWVsZCBhdHRyaWJ1dGVzIG11c3QgYmUgY2x1c3RlcmluZyBrZXlzIG9ubHknLFxuICAgICAgICAgICAgbWF0ZXJpYWxpemVkVmlld05hbWUsXG4gICAgICAgICAgKSkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgdmFsaWRhdGVfaW5kZXgobW9kZWxTY2hlbWEsIGluZGV4RGVmKSB7XG4gICAgaWYgKHR5cGVvZiBpbmRleERlZiAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ2luZGV4ZXMgbXVzdCBiZSBhbiBhcnJheSBvZiBzdHJpbmdzJykpO1xuICAgIH1cblxuICAgIGNvbnN0IGluZGV4TmFtZUxpc3QgPSBpbmRleERlZi5yZXBsYWNlKC9bXCJcXHNdL2csICcnKS5zcGxpdCgvWygpXS9nKTtcbiAgICBpZiAoaW5kZXhOYW1lTGlzdC5sZW5ndGggPiAxKSB7XG4gICAgICBpbmRleE5hbWVMaXN0WzBdID0gaW5kZXhOYW1lTGlzdFswXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKCFbJ2VudHJpZXMnLCAna2V5cycsICd2YWx1ZXMnLCAnZnVsbCddLmluY2x1ZGVzKGluZGV4TmFtZUxpc3RbMF0pKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ2luZGV4IFwiJXNcIiBpcyBub3QgZGVmaW5lZCBwcm9wZXJseScsIGluZGV4RGVmKSkpO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLmhhc19maWVsZChtb2RlbFNjaGVtYSwgaW5kZXhOYW1lTGlzdFsxXSkpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdCgnXCIlc1wiIGlzIG5vdCBhIHZhbGlkIGZpZWxkIG5hbWUsIGluZGV4ZXMgbXVzdCBiZSBkZWZpbmVkIG9uIGZpZWxkIG5hbWVzJywgaW5kZXhOYW1lTGlzdFsxXSkpKTtcbiAgICAgIH1cbiAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbaW5kZXhOYW1lTGlzdFsxXV0gJiYgbW9kZWxTY2hlbWEuZmllbGRzW2luZGV4TmFtZUxpc3RbMV1dLnZpcnR1YWwpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihcImluZGV4ZXMgbXVzdCBiZSBhbiBhcnJheSBvZiBkYiBmaWVsZCBuYW1lcywgY2FuJ3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkc1wiKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5oYXNfZmllbGQobW9kZWxTY2hlbWEsIGluZGV4TmFtZUxpc3RbMF0pKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ1wiJXNcIiBpcyBub3QgYSB2YWxpZCBmaWVsZCwgaW5kZXhlcyBtdXN0IGJlIGRlZmluZWQgb24gZmllbGQgbmFtZXMnLCBpbmRleE5hbWVMaXN0WzBdKSkpO1xuICAgICAgfVxuICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tpbmRleE5hbWVMaXN0WzBdXSAmJiBtb2RlbFNjaGVtYS5maWVsZHNbaW5kZXhOYW1lTGlzdFswXV0udmlydHVhbCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiaW5kZXhlcyBtdXN0IGJlIGFuIGFycmF5IG9mIGRiIGZpZWxkIG5hbWVzLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGRzXCIpKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgdmFsaWRhdGVfY3VzdG9tX2luZGV4KG1vZGVsU2NoZW1hLCBjdXN0b21JbmRleCkge1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KGN1c3RvbUluZGV4KSkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcignY3VzdG9tX2luZGV4IG11c3QgYmUgYW4gb2JqZWN0IHdpdGggcHJvcGVyIGluZGV4aW5nIGF0dHJpYnV0ZXMnKSk7XG4gICAgfVxuICAgIGlmICgodHlwZW9mIChjdXN0b21JbmRleC5vbikgIT09ICdzdHJpbmcnKSB8fCAhdGhpcy5oYXNfZmllbGQobW9kZWxTY2hlbWEsIGN1c3RvbUluZGV4Lm9uKSkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcihcImN1c3RvbV9pbmRleCBtdXN0IGhhdmUgYW4gJ29uJyBhdHRyaWJ1dGUgd2l0aCBzdHJpbmcgdmFsdWUgYW5kIHZhbHVlIG11c3QgYmUgYSB2YWxpZCBmaWVsZCBuYW1lXCIpKTtcbiAgICB9XG4gICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tjdXN0b21JbmRleC5vbl0gJiYgbW9kZWxTY2hlbWEuZmllbGRzW2N1c3RvbUluZGV4Lm9uXS52aXJ0dWFsKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKFwiY3VzdG9tX2luZGV4ICdvbicgYXR0cmlidXRlIG11c3QgYmUgYSBkYiBmaWVsZCBuYW1lLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGRzXCIpKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiAoY3VzdG9tSW5kZXgudXNpbmcpICE9PSAnc3RyaW5nJykge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcihcImN1c3RvbV9pbmRleCBtdXN0IGhhdmUgYSAndXNpbmcnIGF0dHJpYnV0ZSB3aXRoIHN0cmluZyB2YWx1ZVwiKSk7XG4gICAgfVxuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KGN1c3RvbUluZGV4Lm9wdGlvbnMpKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKCdjdXN0b21faW5kZXggbXVzdCBoYXZlIGFuIFwib3B0aW9uc1wiIGF0dHJpYnV0ZSBhbmQgaXQgbXVzdCBiZSBhbiBvYmplY3QsICcgK1xuICAgICAgICAncGFzcyBibGFuayB7fSBvYmplY3QgaWYgbm8gb3B0aW9ucyBhcmUgcmVxdWlyZWQnKSk7XG4gICAgfVxuICB9LFxuXG4gIHZhbGlkYXRlX21vZGVsX3NjaGVtYShtb2RlbFNjaGVtYSkge1xuICAgIGlmICghbW9kZWxTY2hlbWEpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ0Egc2NoZW1hIG11c3QgYmUgc3BlY2lmaWVkJykpO1xuICAgIH1cblxuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1vZGVsU2NoZW1hLmZpZWxkcykgfHwgT2JqZWN0LmtleXMobW9kZWxTY2hlbWEuZmllbGRzKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ1NjaGVtYSBtdXN0IGNvbnRhaW4gYSBub24tZW1wdHkgXCJmaWVsZHNcIiBtYXAgb2JqZWN0JykpO1xuICAgIH1cblxuICAgIGlmICghbW9kZWxTY2hlbWEua2V5IHx8ICFfLmlzQXJyYXkobW9kZWxTY2hlbWEua2V5KSkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcignU2NoZW1hIG11c3QgY29udGFpbiBcImtleVwiIGluIHRoZSBmb3JtOiBbIFtwYXJ0aXRpb25rZXkxLCAuLi5dLCBjbHVzdGVyaW5na2V5MSwgLi4uXScpKTtcbiAgICB9XG5cbiAgICBfLmZvckVhY2gobW9kZWxTY2hlbWEuZmllbGRzLCAoZmllbGRPYmplY3QsIGZpZWxkTmFtZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0ZV9maWVsZChtb2RlbFNjaGVtYSwgZmllbGRPYmplY3QsIGZpZWxkTmFtZSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnZhbGlkYXRlX3ByaW1hcnlfa2V5KG1vZGVsU2NoZW1hKTtcblxuICAgIGlmIChtb2RlbFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MpIHtcbiAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1vZGVsU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cykpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignbWF0ZXJpYWxpemVkX3ZpZXdzIG11c3QgYmUgYW4gb2JqZWN0IHdpdGggdmlldyBuYW1lcyBhcyBhdHRyaWJ1dGVzJykpO1xuICAgICAgfVxuICAgICAgXy5mb3JFYWNoKG1vZGVsU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cywgKG1hdGVyaWFsaXplZFZpZXdPYmplY3QsIG1hdGVyaWFsaXplZFZpZXdOYW1lKSA9PiB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVfbWF0ZXJpYWxpemVkX3ZpZXcobW9kZWxTY2hlbWEsIG1hdGVyaWFsaXplZFZpZXdPYmplY3QsIG1hdGVyaWFsaXplZFZpZXdOYW1lKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChtb2RlbFNjaGVtYS5pbmRleGVzKSB7XG4gICAgICBpZiAoIV8uaXNBcnJheShtb2RlbFNjaGVtYS5pbmRleGVzKSkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKCdpbmRleGVzIG11c3QgYmUgYW4gYXJyYXkgb2YgZmllbGQgbmFtZSBzdHJpbmdzJykpO1xuICAgICAgfVxuXG4gICAgICBtb2RlbFNjaGVtYS5pbmRleGVzLmZvckVhY2goKGluZGV4RGVmKSA9PiB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVfaW5kZXgobW9kZWxTY2hlbWEsIGluZGV4RGVmKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChtb2RlbFNjaGVtYS5jdXN0b21faW5kZXggJiYgbW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4ZXMpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ2JvdGggY3VzdG9tX2luZGV4IGFuZCBjdXN0b21faW5kZXhlcyBhcmUgZGVmaW5lZCBpbiBzY2hlbWEsIG9ubHkgb25lIG9mIHRoZW0gc2hvdWxkIGJlIGRlZmluZWQnKSk7XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleCkge1xuICAgICAgdGhpcy52YWxpZGF0ZV9jdXN0b21faW5kZXgobW9kZWxTY2hlbWEsIG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleCk7XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleGVzKSB7XG4gICAgICBpZiAoIV8uaXNBcnJheShtb2RlbFNjaGVtYS5jdXN0b21faW5kZXhlcykpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignY3VzdG9tX2luZGV4ZXMgbXVzdCBiZSBhbiBhcnJheSB3aXRoIG9iamVjdHMgd2l0aCBwcm9wZXIgaW5kZXhpbmcgYXR0cmlidXRlcycpKTtcbiAgICAgIH1cbiAgICAgIG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleGVzLmZvckVhY2goKGN1c3RvbUluZGV4KSA9PiB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVfY3VzdG9tX2luZGV4KG1vZGVsU2NoZW1hLCBjdXN0b21JbmRleCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgZm9ybWF0X3ZhbGlkYXRpb25fcnVsZShydWxlLCBmaWVsZG5hbWUpIHtcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChydWxlKSkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdCgnVmFsaWRhdGlvbiBydWxlIGZvciBcIiVzXCIgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIG9iamVjdCcsIGZpZWxkbmFtZSkpKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBydWxlLnZhbGlkYXRvciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdCgnUnVsZSB2YWxpZGF0b3IgZm9yIFwiJXNcIiBtdXN0IGJlIGEgdmFsaWQgZnVuY3Rpb24nLCBmaWVsZG5hbWUpKSk7XG4gICAgfVxuICAgIGlmICghcnVsZS5tZXNzYWdlKSB7XG4gICAgICBydWxlLm1lc3NhZ2UgPSB0aGlzLmdldF9nZW5lcmljX3ZhbGlkYXRpb25fbWVzc2FnZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBydWxlLm1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICBydWxlLm1lc3NhZ2UgPSBmdW5jdGlvbiBmMShtZXNzYWdlKSB7XG4gICAgICAgIHJldHVybiB1dGlsLmZvcm1hdChtZXNzYWdlKTtcbiAgICAgIH0uYmluZChudWxsLCBydWxlLm1lc3NhZ2UpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHJ1bGUubWVzc2FnZSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdCgnSW52YWxpZCB2YWxpZGF0b3IgbWVzc2FnZSBmb3IgXCIlc1wiLCBtdXN0IGJlIHN0cmluZyBvciBhIGZ1bmN0aW9uJywgZmllbGRuYW1lKSkpO1xuICAgIH1cbiAgICByZXR1cm4gcnVsZTtcbiAgfSxcblxuICBnZXRfZ2VuZXJpY192YWxpZGF0aW9uX21lc3NhZ2UodmFsdWUsIHByb3BOYW1lLCBmaWVsZHR5cGUpIHtcbiAgICByZXR1cm4gdXRpbC5mb3JtYXQoJ0ludmFsaWQgVmFsdWU6IFwiJXNcIiBmb3IgRmllbGQ6ICVzIChUeXBlOiAlcyknLCB2YWx1ZSwgcHJvcE5hbWUsIGZpZWxkdHlwZSk7XG4gIH0sXG5cbiAgZ2V0X3ZhbGlkYXRpb25fbWVzc2FnZSh2YWxpZGF0b3JzLCB2YWx1ZSkge1xuICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IChfLmlzUGxhaW5PYmplY3QodmFsdWUpICYmIHZhbHVlLiRkYl9mdW5jdGlvbikpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGZvciAobGV0IHYgPSAwOyB2IDwgdmFsaWRhdG9ycy5sZW5ndGg7IHYrKykge1xuICAgICAgaWYgKHR5cGVvZiB2YWxpZGF0b3JzW3ZdLnZhbGlkYXRvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBpZiAoIXZhbGlkYXRvcnNbdl0udmFsaWRhdG9yKHZhbHVlKSkge1xuICAgICAgICAgIHJldHVybiB2YWxpZGF0b3JzW3ZdLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sXG5cbiAgZ2V0X3ZhbGlkYXRvcnMobW9kZWxTY2hlbWEsIGZpZWxkbmFtZSkge1xuICAgIGNvbnN0IHZhbGlkYXRvcnMgPSBbXTtcbiAgICBjb25zdCBmaWVsZHR5cGUgPSB0aGlzLmdldF9maWVsZF90eXBlKG1vZGVsU2NoZW1hLCBmaWVsZG5hbWUpO1xuICAgIGNvbnN0IHR5cGVGaWVsZFZhbGlkYXRvciA9IGRhdGF0eXBlcy5nZW5lcmljX3R5cGVfdmFsaWRhdG9yKGZpZWxkdHlwZSk7XG4gICAgY29uc3QgZmllbGQgPSBtb2RlbFNjaGVtYS5maWVsZHNbZmllbGRuYW1lXTtcblxuICAgIGlmICh0eXBlRmllbGRWYWxpZGF0b3IpIHtcbiAgICAgIGlmICghKGZpZWxkLnJ1bGUgJiYgZmllbGQucnVsZS50eXBlX3ZhbGlkYXRpb24gPT09IGZhbHNlKSkge1xuICAgICAgICB2YWxpZGF0b3JzLnB1c2godHlwZUZpZWxkVmFsaWRhdG9yKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGZpZWxkLnJ1bGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBpZiAodHlwZW9mIGZpZWxkLnJ1bGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgZmllbGQucnVsZSA9IHtcbiAgICAgICAgICB2YWxpZGF0b3I6IGZpZWxkLnJ1bGUsXG4gICAgICAgICAgbWVzc2FnZTogdGhpcy5nZXRfZ2VuZXJpY192YWxpZGF0aW9uX21lc3NhZ2UsXG4gICAgICAgIH07XG4gICAgICAgIHZhbGlkYXRvcnMucHVzaChmaWVsZC5ydWxlKTtcbiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShmaWVsZC5ydWxlLnZhbGlkYXRvcnMpKSB7XG4gICAgICAgIGZpZWxkLnJ1bGUudmFsaWRhdG9ycy5mb3JFYWNoKChmaWVsZHJ1bGUpID0+IHtcbiAgICAgICAgICB2YWxpZGF0b3JzLnB1c2godGhpcy5mb3JtYXRfdmFsaWRhdGlvbl9ydWxlKGZpZWxkcnVsZSwgZmllbGRuYW1lKSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChmaWVsZC5ydWxlLnZhbGlkYXRvcikge1xuICAgICAgICB2YWxpZGF0b3JzLnB1c2godGhpcy5mb3JtYXRfdmFsaWRhdGlvbl9ydWxlKGZpZWxkLnJ1bGUsIGZpZWxkbmFtZSkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB2YWxpZGF0b3JzO1xuICB9LFxuXG4gIGdldF9maWVsZF90eXBlKG1vZGVsU2NoZW1hLCBmaWVsZE5hbWUpIHtcbiAgICBjb25zdCBmaWVsZE9iamVjdCA9IG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuXG4gICAgaWYgKHR5cGVvZiBmaWVsZE9iamVjdCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBmaWVsZE9iamVjdDtcbiAgICB9XG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChmaWVsZE9iamVjdCkpIHtcbiAgICAgIHJldHVybiBmaWVsZE9iamVjdC50eXBlO1xuICAgIH1cbiAgICB0aHJvdyAobmV3IEVycm9yKGBUeXBlIG9mIGZpZWxkIFwiJHtmaWVsZE5hbWV9XCIgbm90IGRlZmluZWQgcHJvcGVybHlgKSk7XG4gIH0sXG5cbiAgaXNfcmVxdWlyZWRfZmllbGQobW9kZWxTY2hlbWEsIGZpZWxkTmFtZSkge1xuICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS5ydWxlICYmIG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnJ1bGUucmVxdWlyZWQpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0sXG5cbiAgaXNfcHJpbWFyeV9rZXlfZmllbGQobW9kZWxTY2hlbWEsIGZpZWxkTmFtZSkge1xuICAgIGlmIChtb2RlbFNjaGVtYS5rZXkuaW5jbHVkZXMoZmllbGROYW1lKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmIChtb2RlbFNjaGVtYS5rZXlbMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBtb2RlbFNjaGVtYS5rZXlbMF0uaW5jbHVkZXMoZmllbGROYW1lKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSxcblxuICBpc19maWVsZF9kZWZhdWx0X3ZhbHVlX3ZhbGlkKG1vZGVsU2NoZW1hLCBmaWVsZE5hbWUpIHtcbiAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdKSAmJiBtb2RlbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS5kZWZhdWx0KSB7XG4gICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLmRlZmF1bHQpXG4gICAgICAgICAgJiYgIShtb2RlbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS5kZWZhdWx0LiRkYl9mdW5jdGlvbikpIHtcbiAgICAgICAgcmV0dXJuIFsnbWFwJywgJ2xpc3QnLCAnc2V0JywgJ2Zyb3plbiddLmluY2x1ZGVzKG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9LFxuXG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHNjaGVtZXI7XG4iXX0=