'use strict';

var _ = require('lodash');
var util = require('util');

var parser = require('./parser');

var arraySort = function arraySort(a, b) {
  if (a > b) return 1;
  if (a < b) return -1;
  return 0;
};

var normalizeTypeDef = function normalizeTypeDef(typeDef) {
  var formattedTypeDef = typeDef.replace(/[\s]/g, '').replace(/varchar/g, 'text').replace(/frozen/ig, 'frozen');
  var frozenMatch = formattedTypeDef.match(/frozen</g);
  if (frozenMatch && frozenMatch.length) return formattedTypeDef.replace(/frozen</g, '').slice(0, -1 * frozenMatch.length);
  return formattedTypeDef;
};

var normalizer = {
  normalize_replication_option(replicationOptions) {
    var normalizedReplicationOptions = replicationOptions;
    Object.keys(normalizedReplicationOptions).forEach(function (key) {
      if (key === 'class') {
        normalizedReplicationOptions[key] = normalizedReplicationOptions[key].replace('org.apache.cassandra.locator.', '');
        return;
      }
      normalizedReplicationOptions[key] = parseInt(normalizedReplicationOptions[key], 10);
    });
    return normalizedReplicationOptions;
  },

  normalize_query_option(options) {
    var queryOptions = { prepare: options.prepare };
    if (options.consistency) queryOptions.consistency = options.consistency;
    if (options.fetchSize) queryOptions.fetchSize = options.fetchSize;
    if (options.autoPage) queryOptions.autoPage = options.autoPage;
    if (options.hints) queryOptions.hints = options.hints;
    if (options.pageState) queryOptions.pageState = options.pageState;
    if (options.retry) queryOptions.retry = options.retry;
    if (options.serialConsistency) queryOptions.serialConsistency = options.serialConsistency;
    if (options.customPayload) queryOptions.customPayload = options.customPayload;
    if (options.isIdempotent) queryOptions.isIdempotent = options.isIdempotent;
    if (options.readTimeout) queryOptions.readTimeout = options.readTimeout;
    if (options.retry) queryOptions.retry = options.retry;
    if (options.retryOnTimeout) queryOptions.retryOnTimeout = options.retryOnTimeout;
    if (options.routingIndexes) queryOptions.routingIndexes = options.routingIndexes;
    if (options.routingKey) queryOptions.routingKey = options.routingKey;
    if (options.routingNames) queryOptions.routingNames = options.routingNames;
    if (options.timestamp) queryOptions.timestamp = options.timestamp;
    return queryOptions;
  },

  normalize_user_defined_type(fieldType) {
    return normalizeTypeDef(fieldType);
  },

  normalize_primary_key(outputSchema) {
    if (outputSchema.key && typeof outputSchema.key[0] === 'string') {
      outputSchema.key[0] = [outputSchema.key[0]];
    }

    if (outputSchema.key && outputSchema.key.length) {
      for (var i = 1; i < outputSchema.key.length; i++) {
        if (!outputSchema.clustering_order) outputSchema.clustering_order = {};
        if (!outputSchema.clustering_order[outputSchema.key[i]]) {
          outputSchema.clustering_order[outputSchema.key[i]] = 'ASC';
        }

        // eslint-disable-next-line max-len
        outputSchema.clustering_order[outputSchema.key[i]] = outputSchema.clustering_order[outputSchema.key[i]].toUpperCase();
      }
    }
  },

  normalize_fields(modelSchema, outputSchema) {
    Object.keys(outputSchema.fields).forEach(function (fieldName) {
      if (typeof outputSchema.fields[fieldName] === 'string') {
        outputSchema.fields[fieldName] = { type: outputSchema.fields[fieldName] };
      }

      if (fieldName === 'solr_query' || outputSchema.fields[fieldName].virtual) {
        delete outputSchema.fields[fieldName];
        return;
      }

      if (outputSchema.fields[fieldName].typeDef) {
        outputSchema.fields[fieldName] = {
          type: outputSchema.fields[fieldName].type,
          typeDef: outputSchema.fields[fieldName].typeDef
        };
      } else {
        outputSchema.fields[fieldName] = { type: outputSchema.fields[fieldName].type };
      }

      if (outputSchema.fields[fieldName].type === 'varchar') {
        outputSchema.fields[fieldName].type = 'text';
      }

      if (['map', 'list', 'set', 'frozen'].includes(outputSchema.fields[fieldName].type)) {
        if (modelSchema.typeMaps && modelSchema.typeMaps[fieldName]) {
          outputSchema.fields[fieldName].typeDef = normalizeTypeDef(modelSchema.typeMaps[fieldName]);
        } else {
          outputSchema.fields[fieldName].typeDef = normalizeTypeDef(outputSchema.fields[fieldName].typeDef);
        }
      }

      if (modelSchema.staticMaps && modelSchema.staticMaps[fieldName] === true) {
        outputSchema.fields[fieldName].static = true;
      } else if (modelSchema.fields[fieldName].static) {
        outputSchema.fields[fieldName].static = true;
      }
    });
  },

  normalize_materialized_views(outputSchema) {
    if (!outputSchema.materialized_views) {
      outputSchema.materialized_views = {};
    }

    Object.keys(outputSchema.materialized_views).forEach(function (materializedViewName) {
      var outputMView = outputSchema.materialized_views[materializedViewName];
      // make parition key an array
      if (outputMView.key && typeof outputMView.key[0] === 'string') {
        outputMView.key[0] = [outputMView.key[0]];
      }

      // add clustering_order for all clustering keys
      if (outputMView.key && outputMView.key.length) {
        for (var i = 1; i < outputMView.key.length; i++) {
          if (!outputMView.clustering_order) {
            outputMView.clustering_order = {};
          }
          if (!outputMView.clustering_order[outputMView.key[i]]) {
            outputMView.clustering_order[outputMView.key[i]] = 'ASC';
          }
          // eslint-disable-next-line max-len
          outputMView.clustering_order[outputMView.key[i]] = outputMView.clustering_order[outputMView.key[i]].toUpperCase();
        }
      }

      // add all non existent primary key items to select and sort them
      for (var pkeyIndex = 0; pkeyIndex < outputMView.key.length; pkeyIndex++) {
        if (pkeyIndex === 0) {
          for (var partitionIndex = 0; partitionIndex < outputMView.key[pkeyIndex].length; partitionIndex++) {
            if (!outputMView.select.includes(outputMView.key[pkeyIndex][partitionIndex])) {
              outputMView.select.push(outputMView.key[pkeyIndex][partitionIndex]);
            }
          }
        } else if (!outputMView.select.includes(outputMView.key[pkeyIndex])) {
          outputMView.select.push(outputMView.key[pkeyIndex]);
        }
      }

      // check if select has * and then add all fields to select
      if (outputMView.select[0] === '*') {
        outputMView.select = Object.keys(outputSchema.fields);
      }

      outputMView.select.sort(arraySort);

      if (!outputMView.where_clause) {
        outputMView.where_clause = parser.get_mview_where_clause(outputSchema, outputMView).trim();
      }
      if (_.isPlainObject(outputMView.filters)) {
        delete outputMView.filters;
      }
    });
  },

  normalize_indexes(outputSchema) {
    if (!outputSchema.indexes) {
      outputSchema.indexes = [];
    }
    for (var i = 0; i < outputSchema.indexes.length; i++) {
      var indexNameList = outputSchema.indexes[i].replace(/["\s]/g, '').split(/[()]/g);
      if (indexNameList.length > 1) {
        indexNameList[0] = indexNameList[0].toLowerCase();
        if (indexNameList[0] === 'values') outputSchema.indexes[i] = indexNameList[1];else outputSchema.indexes[i] = util.format('%s(%s)', indexNameList[0], indexNameList[1]);
      } else {
        outputSchema.indexes[i] = indexNameList[0];
      }
    }
    outputSchema.indexes.sort(arraySort);
  },

  normalize_custom_indexes(outputSchema) {
    if (outputSchema.custom_index) {
      outputSchema.custom_indexes = [outputSchema.custom_index];
      delete outputSchema.custom_index;
    }

    if (outputSchema.custom_indexes) {
      var customArraySort = function customArraySort(a, b) {
        if (a.on > b.on) return 1;
        if (a.on < b.on) return -1;

        if (a.using > b.using) return 1;
        if (a.using < b.using) return -1;

        if (a.options > b.options) return 1;
        if (a.options < b.options) return -1;

        return 0;
      };

      outputSchema.custom_indexes.sort(customArraySort);
    } else {
      outputSchema.custom_indexes = [];
    }

    outputSchema.custom_indexes = _.remove(outputSchema.custom_indexes, function (cindex) {
      return cindex.on !== 'solr_query';
    });
  },

  normalize_model_schema(modelSchema) {
    var outputSchema = _.cloneDeep(modelSchema, true);
    var normalizableSchemaProperties = ['fields', 'key', 'clustering_order', 'materialized_views', 'indexes', 'custom_index', 'custom_indexes'];

    Object.keys(outputSchema).forEach(function (schemaProperty) {
      if (!normalizableSchemaProperties.includes(schemaProperty)) {
        delete outputSchema[schemaProperty];
      }
    });

    this.normalize_fields(modelSchema, outputSchema);
    this.normalize_primary_key(outputSchema);
    this.normalize_materialized_views(outputSchema);
    this.normalize_indexes(outputSchema);
    this.normalize_custom_indexes(outputSchema);

    return outputSchema;
  },

  remove_dependent_views_from_normalized_schema(normalizedDBSchema, dbSchema, fieldName) {
    var dependentViews = [];
    Object.keys(normalizedDBSchema.materialized_views).forEach(function (dbViewName) {
      if (normalizedDBSchema.materialized_views[dbViewName].select.includes(fieldName)) {
        dependentViews.push(dbViewName);
      } else if (normalizedDBSchema.materialized_views[dbViewName].select[0] === '*') {
        dependentViews.push(dbViewName);
      } else if (normalizedDBSchema.materialized_views[dbViewName].key.includes(fieldName)) {
        dependentViews.push(dbViewName);
      } else if (_.isArray(normalizedDBSchema.materialized_views[dbViewName].key[0]) && normalizedDBSchema.materialized_views[dbViewName].key[0].includes(fieldName)) {
        dependentViews.push(dbViewName);
      }
    });
    dependentViews.forEach(function (viewName) {
      normalizedDBSchema.materialized_views[viewName] = {};
    });
  }
};

module.exports = normalizer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9ub3JtYWxpemVyLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwidXRpbCIsInBhcnNlciIsImFycmF5U29ydCIsImEiLCJiIiwibm9ybWFsaXplVHlwZURlZiIsInR5cGVEZWYiLCJmb3JtYXR0ZWRUeXBlRGVmIiwicmVwbGFjZSIsImZyb3plbk1hdGNoIiwibWF0Y2giLCJsZW5ndGgiLCJzbGljZSIsIm5vcm1hbGl6ZXIiLCJub3JtYWxpemVfcmVwbGljYXRpb25fb3B0aW9uIiwicmVwbGljYXRpb25PcHRpb25zIiwibm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9ucyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwia2V5IiwicGFyc2VJbnQiLCJub3JtYWxpemVfcXVlcnlfb3B0aW9uIiwib3B0aW9ucyIsInF1ZXJ5T3B0aW9ucyIsInByZXBhcmUiLCJjb25zaXN0ZW5jeSIsImZldGNoU2l6ZSIsImF1dG9QYWdlIiwiaGludHMiLCJwYWdlU3RhdGUiLCJyZXRyeSIsInNlcmlhbENvbnNpc3RlbmN5IiwiY3VzdG9tUGF5bG9hZCIsImlzSWRlbXBvdGVudCIsInJlYWRUaW1lb3V0IiwicmV0cnlPblRpbWVvdXQiLCJyb3V0aW5nSW5kZXhlcyIsInJvdXRpbmdLZXkiLCJyb3V0aW5nTmFtZXMiLCJ0aW1lc3RhbXAiLCJub3JtYWxpemVfdXNlcl9kZWZpbmVkX3R5cGUiLCJmaWVsZFR5cGUiLCJub3JtYWxpemVfcHJpbWFyeV9rZXkiLCJvdXRwdXRTY2hlbWEiLCJpIiwiY2x1c3RlcmluZ19vcmRlciIsInRvVXBwZXJDYXNlIiwibm9ybWFsaXplX2ZpZWxkcyIsIm1vZGVsU2NoZW1hIiwiZmllbGRzIiwiZmllbGROYW1lIiwidHlwZSIsInZpcnR1YWwiLCJpbmNsdWRlcyIsInR5cGVNYXBzIiwic3RhdGljTWFwcyIsInN0YXRpYyIsIm5vcm1hbGl6ZV9tYXRlcmlhbGl6ZWRfdmlld3MiLCJtYXRlcmlhbGl6ZWRfdmlld3MiLCJtYXRlcmlhbGl6ZWRWaWV3TmFtZSIsIm91dHB1dE1WaWV3IiwicGtleUluZGV4IiwicGFydGl0aW9uSW5kZXgiLCJzZWxlY3QiLCJwdXNoIiwic29ydCIsIndoZXJlX2NsYXVzZSIsImdldF9tdmlld193aGVyZV9jbGF1c2UiLCJ0cmltIiwiaXNQbGFpbk9iamVjdCIsImZpbHRlcnMiLCJub3JtYWxpemVfaW5kZXhlcyIsImluZGV4ZXMiLCJpbmRleE5hbWVMaXN0Iiwic3BsaXQiLCJ0b0xvd2VyQ2FzZSIsImZvcm1hdCIsIm5vcm1hbGl6ZV9jdXN0b21faW5kZXhlcyIsImN1c3RvbV9pbmRleCIsImN1c3RvbV9pbmRleGVzIiwiY3VzdG9tQXJyYXlTb3J0Iiwib24iLCJ1c2luZyIsInJlbW92ZSIsImNpbmRleCIsIm5vcm1hbGl6ZV9tb2RlbF9zY2hlbWEiLCJjbG9uZURlZXAiLCJub3JtYWxpemFibGVTY2hlbWFQcm9wZXJ0aWVzIiwic2NoZW1hUHJvcGVydHkiLCJyZW1vdmVfZGVwZW5kZW50X3ZpZXdzX2Zyb21fbm9ybWFsaXplZF9zY2hlbWEiLCJub3JtYWxpemVkREJTY2hlbWEiLCJkYlNjaGVtYSIsImRlcGVuZGVudFZpZXdzIiwiZGJWaWV3TmFtZSIsImlzQXJyYXkiLCJ2aWV3TmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsSUFBSUMsUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNQyxPQUFPRCxRQUFRLE1BQVIsQ0FBYjs7QUFFQSxJQUFNRSxTQUFTRixRQUFRLFVBQVIsQ0FBZjs7QUFFQSxJQUFNRyxZQUFZLFNBQVpBLFNBQVksQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEVBQVU7QUFDMUIsTUFBSUQsSUFBSUMsQ0FBUixFQUFXLE9BQU8sQ0FBUDtBQUNYLE1BQUlELElBQUlDLENBQVIsRUFBVyxPQUFPLENBQUMsQ0FBUjtBQUNYLFNBQU8sQ0FBUDtBQUNELENBSkQ7O0FBTUEsSUFBTUMsbUJBQW1CLFNBQW5CQSxnQkFBbUIsQ0FBQ0MsT0FBRCxF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QUF0QyxFQUFrRDFFLEdBQWxELENBQXNELENBQXRELEVBQXlEa0MsUUFBekQsQ0FBa0VILFNBQWxFLENBRFIsRUFDc0Y7QUFDM0YwQyx1QkFBZTVCLElBQWYsQ0FBb0I2QixVQUFwQjtBQUNEO0FBQ0YsS0FYRDtBQVlBRCxtQkFBZTFFLE9BQWYsQ0FBdUIsVUFBQzZFLFFBQUQsRUFBYztBQUNuQ0wseUJBQW1CaEMsa0JBQW5CLENBQXNDcUMsUUFBdEMsSUFBa0QsRUFBbEQ7QUFDRCxLQUZEO0FBR0Q7QUExT2dCLENBQW5COztBQTZPQUMsT0FBT0MsT0FBUCxHQUFpQnJGLFVBQWpCIiwiZmlsZSI6Im5vcm1hbGl6ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xuXG5jb25zdCBwYXJzZXIgPSByZXF1aXJlKCcuL3BhcnNlcicpO1xuXG5jb25zdCBhcnJheVNvcnQgPSAoYSwgYikgPT4ge1xuICBpZiAoYSA+IGIpIHJldHVybiAxO1xuICBpZiAoYSA8IGIpIHJldHVybiAtMTtcbiAgcmV0dXJuIDA7XG59O1xuXG5jb25zdCBub3JtYWxpemVUeXBlRGVmID0gKHR5cGVEZWYpID0+IHtcbiAgY29uc3QgZm9ybWF0dGVkVHlwZURlZiA9IHR5cGVEZWYucmVwbGFjZSgvW1xcc10vZywgJycpLnJlcGxhY2UoL3ZhcmNoYXIvZywgJ3RleHQnKS5yZXBsYWNlKC9mcm96ZW4vaWcsICdmcm96ZW4nKTtcbiAgY29uc3QgZnJvemVuTWF0Y2ggPSBmb3JtYXR0ZWRUeXBlRGVmLm1hdGNoKC9mcm96ZW48L2cpO1xuICBpZiAoZnJvemVuTWF0Y2ggJiYgZnJvemVuTWF0Y2gubGVuZ3RoKSByZXR1cm4gZm9ybWF0dGVkVHlwZURlZi5yZXBsYWNlKC9mcm96ZW48L2csICcnKS5zbGljZSgwLCAtMSAqIGZyb3plbk1hdGNoLmxlbmd0aCk7XG4gIHJldHVybiBmb3JtYXR0ZWRUeXBlRGVmO1xufTtcblxuY29uc3Qgbm9ybWFsaXplciA9IHtcbiAgbm9ybWFsaXplX3JlcGxpY2F0aW9uX29wdGlvbihyZXBsaWNhdGlvbk9wdGlvbnMpIHtcbiAgICBjb25zdCBub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zID0gcmVwbGljYXRpb25PcHRpb25zO1xuICAgIE9iamVjdC5rZXlzKG5vcm1hbGl6ZWRSZXBsaWNhdGlvbk9wdGlvbnMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gJ2NsYXNzJykge1xuICAgICAgICBub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zW2tleV0gPSBub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zW2tleV0ucmVwbGFjZSgnb3JnLmFwYWNoZS5jYXNzYW5kcmEubG9jYXRvci4nLCAnJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIG5vcm1hbGl6ZWRSZXBsaWNhdGlvbk9wdGlvbnNba2V5XSA9IHBhcnNlSW50KG5vcm1hbGl6ZWRSZXBsaWNhdGlvbk9wdGlvbnNba2V5XSwgMTApO1xuICAgIH0pO1xuICAgIHJldHVybiBub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zO1xuICB9LFxuXG4gIG5vcm1hbGl6ZV9xdWVyeV9vcHRpb24ob3B0aW9ucykge1xuICAgIGNvbnN0IHF1ZXJ5T3B0aW9ucyA9IHsgcHJlcGFyZTogb3B0aW9ucy5wcmVwYXJlIH07XG4gICAgaWYgKG9wdGlvbnMuY29uc2lzdGVuY3kpIHF1ZXJ5T3B0aW9ucy5jb25zaXN0ZW5jeSA9IG9wdGlvbnMuY29uc2lzdGVuY3k7XG4gICAgaWYgKG9wdGlvbnMuZmV0Y2hTaXplKSBxdWVyeU9wdGlvbnMuZmV0Y2hTaXplID0gb3B0aW9ucy5mZXRjaFNpemU7XG4gICAgaWYgKG9wdGlvbnMuYXV0b1BhZ2UpIHF1ZXJ5T3B0aW9ucy5hdXRvUGFnZSA9IG9wdGlvbnMuYXV0b1BhZ2U7XG4gICAgaWYgKG9wdGlvbnMuaGludHMpIHF1ZXJ5T3B0aW9ucy5oaW50cyA9IG9wdGlvbnMuaGludHM7XG4gICAgaWYgKG9wdGlvbnMucGFnZVN0YXRlKSBxdWVyeU9wdGlvbnMucGFnZVN0YXRlID0gb3B0aW9ucy5wYWdlU3RhdGU7XG4gICAgaWYgKG9wdGlvbnMucmV0cnkpIHF1ZXJ5T3B0aW9ucy5yZXRyeSA9IG9wdGlvbnMucmV0cnk7XG4gICAgaWYgKG9wdGlvbnMuc2VyaWFsQ29uc2lzdGVuY3kpIHF1ZXJ5T3B0aW9ucy5zZXJpYWxDb25zaXN0ZW5jeSA9IG9wdGlvbnMuc2VyaWFsQ29uc2lzdGVuY3k7XG4gICAgaWYgKG9wdGlvbnMuY3VzdG9tUGF5bG9hZCkgcXVlcnlPcHRpb25zLmN1c3RvbVBheWxvYWQgPSBvcHRpb25zLmN1c3RvbVBheWxvYWQ7XG4gICAgaWYgKG9wdGlvbnMuaXNJZGVtcG90ZW50KSBxdWVyeU9wdGlvbnMuaXNJZGVtcG90ZW50ID0gb3B0aW9ucy5pc0lkZW1wb3RlbnQ7XG4gICAgaWYgKG9wdGlvbnMucmVhZFRpbWVvdXQpIHF1ZXJ5T3B0aW9ucy5yZWFkVGltZW91dCA9IG9wdGlvbnMucmVhZFRpbWVvdXQ7XG4gICAgaWYgKG9wdGlvbnMucmV0cnkpIHF1ZXJ5T3B0aW9ucy5yZXRyeSA9IG9wdGlvbnMucmV0cnk7XG4gICAgaWYgKG9wdGlvbnMucmV0cnlPblRpbWVvdXQpIHF1ZXJ5T3B0aW9ucy5yZXRyeU9uVGltZW91dCA9IG9wdGlvbnMucmV0cnlPblRpbWVvdXQ7XG4gICAgaWYgKG9wdGlvbnMucm91dGluZ0luZGV4ZXMpIHF1ZXJ5T3B0aW9ucy5yb3V0aW5nSW5kZXhlcyA9IG9wdGlvbnMucm91dGluZ0luZGV4ZXM7XG4gICAgaWYgKG9wdGlvbnMucm91dGluZ0tleSkgcXVlcnlPcHRpb25zLnJvdXRpbmdLZXkgPSBvcHRpb25zLnJvdXRpbmdLZXk7XG4gICAgaWYgKG9wdGlvbnMucm91dGluZ05hbWVzKSBxdWVyeU9wdGlvbnMucm91dGluZ05hbWVzID0gb3B0aW9ucy5yb3V0aW5nTmFtZXM7XG4gICAgaWYgKG9wdGlvbnMudGltZXN0YW1wKSBxdWVyeU9wdGlvbnMudGltZXN0YW1wID0gb3B0aW9ucy50aW1lc3RhbXA7XG4gICAgcmV0dXJuIHF1ZXJ5T3B0aW9ucztcbiAgfSxcblxuICBub3JtYWxpemVfdXNlcl9kZWZpbmVkX3R5cGUoZmllbGRUeXBlKSB7XG4gICAgcmV0dXJuIG5vcm1hbGl6ZVR5cGVEZWYoZmllbGRUeXBlKTtcbiAgfSxcblxuICBub3JtYWxpemVfcHJpbWFyeV9rZXkob3V0cHV0U2NoZW1hKSB7XG4gICAgaWYgKG91dHB1dFNjaGVtYS5rZXkgJiYgdHlwZW9mIG91dHB1dFNjaGVtYS5rZXlbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICBvdXRwdXRTY2hlbWEua2V5WzBdID0gW291dHB1dFNjaGVtYS5rZXlbMF1dO1xuICAgIH1cblxuICAgIGlmIChvdXRwdXRTY2hlbWEua2V5ICYmIG91dHB1dFNjaGVtYS5rZXkubGVuZ3RoKSB7XG4gICAgICBmb3IgKGxldCBpID0gMTsgaSA8IG91dHB1dFNjaGVtYS5rZXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKCFvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcikgb3V0cHV0U2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXIgPSB7fTtcbiAgICAgICAgaWYgKCFvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcltvdXRwdXRTY2hlbWEua2V5W2ldXSkge1xuICAgICAgICAgIG91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyW291dHB1dFNjaGVtYS5rZXlbaV1dID0gJ0FTQyc7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgICAgICBvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcltvdXRwdXRTY2hlbWEua2V5W2ldXSA9IG91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyW291dHB1dFNjaGVtYS5rZXlbaV1dLnRvVXBwZXJDYXNlKCk7XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIG5vcm1hbGl6ZV9maWVsZHMobW9kZWxTY2hlbWEsIG91dHB1dFNjaGVtYSkge1xuICAgIE9iamVjdC5rZXlzKG91dHB1dFNjaGVtYS5maWVsZHMpLmZvckVhY2goKGZpZWxkTmFtZSkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiAob3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdID0geyB0eXBlOiBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0gfTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZpZWxkTmFtZSA9PT0gJ3NvbHJfcXVlcnknIHx8IG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS52aXJ0dWFsKSB7XG4gICAgICAgIGRlbGV0ZSBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlRGVmKSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSA9IHtcbiAgICAgICAgICB0eXBlOiBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZSxcbiAgICAgICAgICB0eXBlRGVmOiBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZURlZixcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSA9IHsgdHlwZTogb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGUgfTtcbiAgICAgIH1cblxuICAgICAgaWYgKG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlID09PSAndmFyY2hhcicpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGUgPSAndGV4dCc7XG4gICAgICB9XG5cbiAgICAgIGlmIChbJ21hcCcsICdsaXN0JywgJ3NldCcsICdmcm96ZW4nXS5pbmNsdWRlcyhvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZSkpIHtcbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLnR5cGVNYXBzICYmIG1vZGVsU2NoZW1hLnR5cGVNYXBzW2ZpZWxkTmFtZV0pIHtcbiAgICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZURlZiA9IG5vcm1hbGl6ZVR5cGVEZWYobW9kZWxTY2hlbWEudHlwZU1hcHNbZmllbGROYW1lXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGVEZWYgPSBub3JtYWxpemVUeXBlRGVmKG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlRGVmKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAobW9kZWxTY2hlbWEuc3RhdGljTWFwcyAmJiBtb2RlbFNjaGVtYS5zdGF0aWNNYXBzW2ZpZWxkTmFtZV0gPT09IHRydWUpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnN0YXRpYyA9IHRydWU7XG4gICAgICB9IGVsc2UgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnN0YXRpYykge1xuICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0uc3RhdGljID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcblxuICBub3JtYWxpemVfbWF0ZXJpYWxpemVkX3ZpZXdzKG91dHB1dFNjaGVtYSkge1xuICAgIGlmICghb3V0cHV0U2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cykge1xuICAgICAgb3V0cHV0U2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cyA9IHt9O1xuICAgIH1cblxuICAgIE9iamVjdC5rZXlzKG91dHB1dFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MpLmZvckVhY2goKG1hdGVyaWFsaXplZFZpZXdOYW1lKSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXRNVmlldyA9IG91dHB1dFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbbWF0ZXJpYWxpemVkVmlld05hbWVdO1xuICAgICAgLy8gbWFrZSBwYXJpdGlvbiBrZXkgYW4gYXJyYXlcbiAgICAgIGlmIChvdXRwdXRNVmlldy5rZXkgJiYgdHlwZW9mIG91dHB1dE1WaWV3LmtleVswXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb3V0cHV0TVZpZXcua2V5WzBdID0gW291dHB1dE1WaWV3LmtleVswXV07XG4gICAgICB9XG5cbiAgICAgIC8vIGFkZCBjbHVzdGVyaW5nX29yZGVyIGZvciBhbGwgY2x1c3RlcmluZyBrZXlzXG4gICAgICBpZiAob3V0cHV0TVZpZXcua2V5ICYmIG91dHB1dE1WaWV3LmtleS5sZW5ndGgpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBvdXRwdXRNVmlldy5rZXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAoIW91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXIpIHtcbiAgICAgICAgICAgIG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXIgPSB7fTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0pIHtcbiAgICAgICAgICAgIG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0TVZpZXcua2V5W2ldXSA9ICdBU0MnO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgICAgICAgIG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0TVZpZXcua2V5W2ldXSA9IG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0TVZpZXcua2V5W2ldXS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIGFkZCBhbGwgbm9uIGV4aXN0ZW50IHByaW1hcnkga2V5IGl0ZW1zIHRvIHNlbGVjdCBhbmQgc29ydCB0aGVtXG4gICAgICBmb3IgKGxldCBwa2V5SW5kZXggPSAwOyBwa2V5SW5kZXggPCBvdXRwdXRNVmlldy5rZXkubGVuZ3RoOyBwa2V5SW5kZXgrKykge1xuICAgICAgICBpZiAocGtleUluZGV4ID09PSAwKSB7XG4gICAgICAgICAgZm9yIChsZXQgcGFydGl0aW9uSW5kZXggPSAwOyBwYXJ0aXRpb25JbmRleCA8IG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdLmxlbmd0aDsgcGFydGl0aW9uSW5kZXgrKykge1xuICAgICAgICAgICAgaWYgKCFvdXRwdXRNVmlldy5zZWxlY3QuaW5jbHVkZXMob3V0cHV0TVZpZXcua2V5W3BrZXlJbmRleF1bcGFydGl0aW9uSW5kZXhdKSkge1xuICAgICAgICAgICAgICBvdXRwdXRNVmlldy5zZWxlY3QucHVzaChvdXRwdXRNVmlldy5rZXlbcGtleUluZGV4XVtwYXJ0aXRpb25JbmRleF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICghb3V0cHV0TVZpZXcuc2VsZWN0LmluY2x1ZGVzKG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdKSkge1xuICAgICAgICAgIG91dHB1dE1WaWV3LnNlbGVjdC5wdXNoKG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBjaGVjayBpZiBzZWxlY3QgaGFzICogYW5kIHRoZW4gYWRkIGFsbCBmaWVsZHMgdG8gc2VsZWN0XG4gICAgICBpZiAob3V0cHV0TVZpZXcuc2VsZWN0WzBdID09PSAnKicpIHtcbiAgICAgICAgb3V0cHV0TVZpZXcuc2VsZWN0ID0gT2JqZWN0LmtleXMob3V0cHV0U2NoZW1hLmZpZWxkcyk7XG4gICAgICB9XG5cbiAgICAgIG91dHB1dE1WaWV3LnNlbGVjdC5zb3J0KGFycmF5U29ydCk7XG5cbiAgICAgIGlmICghb3V0cHV0TVZpZXcud2hlcmVfY2xhdXNlKSB7XG4gICAgICAgIG91dHB1dE1WaWV3LndoZXJlX2NsYXVzZSA9IHBhcnNlci5nZXRfbXZpZXdfd2hlcmVfY2xhdXNlKG91dHB1dFNjaGVtYSwgb3V0cHV0TVZpZXcpLnRyaW0oKTtcbiAgICAgIH1cbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3Qob3V0cHV0TVZpZXcuZmlsdGVycykpIHtcbiAgICAgICAgZGVsZXRlIG91dHB1dE1WaWV3LmZpbHRlcnM7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgbm9ybWFsaXplX2luZGV4ZXMob3V0cHV0U2NoZW1hKSB7XG4gICAgaWYgKCFvdXRwdXRTY2hlbWEuaW5kZXhlcykge1xuICAgICAgb3V0cHV0U2NoZW1hLmluZGV4ZXMgPSBbXTtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvdXRwdXRTY2hlbWEuaW5kZXhlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaW5kZXhOYW1lTGlzdCA9IG91dHB1dFNjaGVtYS5pbmRleGVzW2ldLnJlcGxhY2UoL1tcIlxcc10vZywgJycpLnNwbGl0KC9bKCldL2cpO1xuICAgICAgaWYgKGluZGV4TmFtZUxpc3QubGVuZ3RoID4gMSkge1xuICAgICAgICBpbmRleE5hbWVMaXN0WzBdID0gaW5kZXhOYW1lTGlzdFswXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAoaW5kZXhOYW1lTGlzdFswXSA9PT0gJ3ZhbHVlcycpIG91dHB1dFNjaGVtYS5pbmRleGVzW2ldID0gaW5kZXhOYW1lTGlzdFsxXTtcbiAgICAgICAgZWxzZSBvdXRwdXRTY2hlbWEuaW5kZXhlc1tpXSA9IHV0aWwuZm9ybWF0KCclcyglcyknLCBpbmRleE5hbWVMaXN0WzBdLCBpbmRleE5hbWVMaXN0WzFdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5pbmRleGVzW2ldID0gaW5kZXhOYW1lTGlzdFswXTtcbiAgICAgIH1cbiAgICB9XG4gICAgb3V0cHV0U2NoZW1hLmluZGV4ZXMuc29ydChhcnJheVNvcnQpO1xuICB9LFxuXG4gIG5vcm1hbGl6ZV9jdXN0b21faW5kZXhlcyhvdXRwdXRTY2hlbWEpIHtcbiAgICBpZiAob3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleCkge1xuICAgICAgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzID0gW291dHB1dFNjaGVtYS5jdXN0b21faW5kZXhdO1xuICAgICAgZGVsZXRlIG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXg7XG4gICAgfVxuXG4gICAgaWYgKG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXhlcykge1xuICAgICAgY29uc3QgY3VzdG9tQXJyYXlTb3J0ID0gKGEsIGIpID0+IHtcbiAgICAgICAgaWYgKGEub24gPiBiLm9uKSByZXR1cm4gMTtcbiAgICAgICAgaWYgKGEub24gPCBiLm9uKSByZXR1cm4gLTE7XG5cbiAgICAgICAgaWYgKGEudXNpbmcgPiBiLnVzaW5nKSByZXR1cm4gMTtcbiAgICAgICAgaWYgKGEudXNpbmcgPCBiLnVzaW5nKSByZXR1cm4gLTE7XG5cbiAgICAgICAgaWYgKGEub3B0aW9ucyA+IGIub3B0aW9ucykgcmV0dXJuIDE7XG4gICAgICAgIGlmIChhLm9wdGlvbnMgPCBiLm9wdGlvbnMpIHJldHVybiAtMTtcblxuICAgICAgICByZXR1cm4gMDtcbiAgICAgIH07XG5cbiAgICAgIG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXhlcy5zb3J0KGN1c3RvbUFycmF5U29ydCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXhlcyA9IFtdO1xuICAgIH1cblxuICAgIG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXhlcyA9IF8ucmVtb3ZlKG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXhlcywgKGNpbmRleCkgPT4gKGNpbmRleC5vbiAhPT0gJ3NvbHJfcXVlcnknKSk7XG4gIH0sXG5cbiAgbm9ybWFsaXplX21vZGVsX3NjaGVtYShtb2RlbFNjaGVtYSkge1xuICAgIGNvbnN0IG91dHB1dFNjaGVtYSA9IF8uY2xvbmVEZWVwKG1vZGVsU2NoZW1hLCB0cnVlKTtcbiAgICBjb25zdCBub3JtYWxpemFibGVTY2hlbWFQcm9wZXJ0aWVzID0gW1xuICAgICAgJ2ZpZWxkcycsICdrZXknLCAnY2x1c3RlcmluZ19vcmRlcicsICdtYXRlcmlhbGl6ZWRfdmlld3MnLCAnaW5kZXhlcycsICdjdXN0b21faW5kZXgnLCAnY3VzdG9tX2luZGV4ZXMnLFxuICAgIF07XG5cbiAgICBPYmplY3Qua2V5cyhvdXRwdXRTY2hlbWEpLmZvckVhY2goKHNjaGVtYVByb3BlcnR5KSA9PiB7XG4gICAgICBpZiAoIW5vcm1hbGl6YWJsZVNjaGVtYVByb3BlcnRpZXMuaW5jbHVkZXMoc2NoZW1hUHJvcGVydHkpKSB7XG4gICAgICAgIGRlbGV0ZSBvdXRwdXRTY2hlbWFbc2NoZW1hUHJvcGVydHldO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5ub3JtYWxpemVfZmllbGRzKG1vZGVsU2NoZW1hLCBvdXRwdXRTY2hlbWEpO1xuICAgIHRoaXMubm9ybWFsaXplX3ByaW1hcnlfa2V5KG91dHB1dFNjaGVtYSk7XG4gICAgdGhpcy5ub3JtYWxpemVfbWF0ZXJpYWxpemVkX3ZpZXdzKG91dHB1dFNjaGVtYSk7XG4gICAgdGhpcy5ub3JtYWxpemVfaW5kZXhlcyhvdXRwdXRTY2hlbWEpO1xuICAgIHRoaXMubm9ybWFsaXplX2N1c3RvbV9pbmRleGVzKG91dHB1dFNjaGVtYSk7XG5cbiAgICByZXR1cm4gb3V0cHV0U2NoZW1hO1xuICB9LFxuXG4gIHJlbW92ZV9kZXBlbmRlbnRfdmlld3NfZnJvbV9ub3JtYWxpemVkX3NjaGVtYShub3JtYWxpemVkREJTY2hlbWEsIGRiU2NoZW1hLCBmaWVsZE5hbWUpIHtcbiAgICBjb25zdCBkZXBlbmRlbnRWaWV3cyA9IFtdO1xuICAgIE9iamVjdC5rZXlzKG5vcm1hbGl6ZWREQlNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MpLmZvckVhY2goKGRiVmlld05hbWUpID0+IHtcbiAgICAgIGlmIChub3JtYWxpemVkREJTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzW2RiVmlld05hbWVdLnNlbGVjdC5pbmNsdWRlcyhmaWVsZE5hbWUpKSB7XG4gICAgICAgIGRlcGVuZGVudFZpZXdzLnB1c2goZGJWaWV3TmFtZSk7XG4gICAgICB9IGVsc2UgaWYgKG5vcm1hbGl6ZWREQlNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbZGJWaWV3TmFtZV0uc2VsZWN0WzBdID09PSAnKicpIHtcbiAgICAgICAgZGVwZW5kZW50Vmlld3MucHVzaChkYlZpZXdOYW1lKTtcbiAgICAgIH0gZWxzZSBpZiAobm9ybWFsaXplZERCU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3c1tkYlZpZXdOYW1lXS5rZXkuaW5jbHVkZXMoZmllbGROYW1lKSkge1xuICAgICAgICBkZXBlbmRlbnRWaWV3cy5wdXNoKGRiVmlld05hbWUpO1xuICAgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkobm9ybWFsaXplZERCU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3c1tkYlZpZXdOYW1lXS5rZXlbMF0pXG4gICAgICAgICAgICAgICAgICAmJiBub3JtYWxpemVkREJTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzW2RiVmlld05hbWVdLmtleVswXS5pbmNsdWRlcyhmaWVsZE5hbWUpKSB7XG4gICAgICAgIGRlcGVuZGVudFZpZXdzLnB1c2goZGJWaWV3TmFtZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgZGVwZW5kZW50Vmlld3MuZm9yRWFjaCgodmlld05hbWUpID0+IHtcbiAgICAgIG5vcm1hbGl6ZWREQlNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3Nbdmlld05hbWVdID0ge307XG4gICAgfSk7XG4gIH0sXG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IG5vcm1hbGl6ZXI7XG4iXX0=